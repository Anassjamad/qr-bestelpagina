<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bestellen</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #f4fdf7;
            margin: 0;
            overflow-x: hidden;
        }

        h2 {
            text-align: center;
            color: #2e7d32;
            margin-bottom: 20px;
            animation: fadeIn 1s ease forwards;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            padding: 20px;
        }

        .order-type {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            animation: fadeInUp 1s ease forwards;
        }

            .order-type button {
                font-size: 1.2rem;
                padding: 12px 25px;
                border: none;
                border-radius: 10px;
                background-color: #4caf50;
                color: white;
                cursor: pointer;
                transition: transform 0.2s, background-color 0.2s;
            }

                .order-type button:hover {
                    transform: scale(1.05);
                }

                .order-type button.selected {
                    background-color: #388e3c;
                }

        .products {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s forwards;
        }

        .product {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            width: 200px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

            .product:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            }

            .product img {
                width: 100px;
                height: 100px;
                object-fit: cover;
                border-radius: 10px;
                margin-bottom: 10px;
            }

        .product-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 10px;
        }

            .product-controls button {
                background-color: #4caf50;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 1rem;
                cursor: pointer;
                transition: transform 0.2s;
            }

                .product-controls button:hover {
                    transform: scale(1.1);
                }

        .opmerking {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 100%;
            display: none;
        }

        #orderForm {
            display: none;
            animation: fadeIn 0.8s ease forwards;
        }

            #orderForm h3 {
                text-align: center;
                margin-bottom: 20px;
            }

        #orderItems p {
            margin: 5px 0;
        }

        button[type="submit"], button.cancel {
            margin-top: 20px;
            width: 100%;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }

        button[type="submit"] {
            background-color: #4caf50;
            color: white;
        }

        button.cancel {
            background-color: #b71c1c;
            color: white;
        }

        button[type="submit"]:hover {
            transform: scale(1.05);
            background-color: #388e3c;
        }

        button.cancel:hover {
            transform: scale(1.05);
            background-color: #7f0000;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 999;
        }

            #loadingOverlay .spinner {
                border: 8px solid #f3f3f3;
                border-top: 8px solid #4caf50;
                border-radius: 50%;
                width: 80px;
                height: 80px;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-size:1.2rem;color:#333;">Wachten op betaling...</div>
    </div>
    <div class="container">
        <h2>Bestel je producten</h2>
        <div id="kioskDisplay" style="margin-bottom: 20px; font-weight: bold;"></div>
        <div class="order-type" id="orderTypeSelection">
            <button id="btnPickup" data-type="pickup">Ter plaatse eten</button>
            <button id="btnTakeaway" data-type="takeaway">Afhalen</button>
        </div>
        <div class="products" id="productsContainer"></div>
        <form id="orderForm">
            <h3>Bestelformulier</h3>
            <div id="orderItems"></div>
            <button type="submit">Bestelling plaatsen & betalen</button>
            <button type="button" class="cancel" id="cancelOrderBtn">Annuleer bestelling</button>
        </form>
    </div>

    <script>
        const backendUrl = 'https://bestel-backend.onrender.com';
        const urlParams = new URLSearchParams(window.location.search);
        const selectedKiosk = parseInt(urlParams.get('kiosk'));
        if (!selectedKiosk) { alert("⛔ Kiosknummer ontbreekt in URL."); throw new Error("Geen kiosknummer in URL."); }
        document.getElementById("kioskDisplay").textContent = `Bestellen vanaf kiosk ${selectedKiosk}`;

        let selectedOrderType = null;
        let producten = [];
        let bestelling = [];

        const btnPickup = document.getElementById('btnPickup');
        const btnTakeaway = document.getElementById('btnTakeaway');
        const productsContainer = document.getElementById('productsContainer');
        const orderForm = document.getElementById('orderForm');
        const orderItemsDiv = document.getElementById('orderItems');
        const cancelOrderBtn = document.getElementById('cancelOrderBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        btnPickup.addEventListener('click', () => selectOrderType('pickup'));
        btnTakeaway.addEventListener('click', () => selectOrderType('takeaway'));

        function selectOrderType(type) {
            selectedOrderType = type;
            btnPickup.classList.toggle('selected', type === 'pickup');
            btnTakeaway.classList.toggle('selected', type === 'takeaway');
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${backendUrl}/products`);
                if (!res.ok) throw new Error('Kan producten niet ophalen.');
                producten = await res.json();
                showProducts();
            } catch (error) {
                alert('⛔ Kan producten niet ophalen.');
                console.error(error);
            }
        }

        function showProducts() {
            document.getElementById('orderTypeSelection').style.display = 'none';
            productsContainer.style.display = 'flex';
            productsContainer.innerHTML = '';

            producten.forEach((product, i) => {
                const div = document.createElement('div');
                div.className = 'product';
                div.innerHTML = `
                        <img src="${product.image || 'https://via.placeholder.com/100'}" alt="${product.naam}">
                        <h3>${product.naam}</h3>
                        <p>€${product.prijs.toFixed(2)}</p>
                        <div class="product-controls">
                            <button data-index="${i}" class="btn-decrease">-</button>
                            <span id="qty-${i}">0</span>
                            <button data-index="${i}" class="btn-increase">+</button>
                        </div>
                        <textarea placeholder="Opmerking (optioneel)" class="opmerking" id="note-${i}"></textarea>
                    `;
                productsContainer.appendChild(div);

                const btnInc = div.querySelector('.btn-increase');
                const btnDec = div.querySelector('.btn-decrease');
                const note = div.querySelector('textarea');

                btnInc.addEventListener('click', () => {
                    let q = parseInt(document.getElementById(`qty-${i}`).textContent);
                    q++;
                    document.getElementById(`qty-${i}`).textContent = q;
                    note.style.display = q > 0 ? 'block' : 'none';
                });

                btnDec.addEventListener('click', () => {
                    let q = parseInt(document.getElementById(`qty-${i}`).textContent);
                    if (q > 0) {
                        q--;
                        document.getElementById(`qty-${i}`).textContent = q;
                        note.style.display = q > 0 ? 'block' : 'none';
                        if (q === 0) note.value = '';
                    }
                });
            });

            const btnNext = document.createElement('button');
            btnNext.textContent = 'Verder naar bestelling';
            btnNext.style.cssText = 'margin-top:20px;padding:16px;font-size:1.2rem;width:100%;background-color:#4caf50;color:white;border:none;border-radius:15px;cursor:pointer;';
            productsContainer.appendChild(btnNext);
            btnNext.addEventListener('click', e => { e.preventDefault(); prepareOrderForm(); });
        }

        function prepareOrderForm() {
            bestelling = [];
            producten.forEach((p, i) => {
                const qty = parseInt(document.getElementById(`qty-${i}`).textContent);
                const note = document.getElementById(`note-${i}`).value.trim();
                if (qty > 0) bestelling.push({ item: p.naam, quantity: qty, opmerking: note || '', prijs: p.prijs });
            });
            if (bestelling.length === 0) { alert('Selecteer minimaal één product.'); return; }
            productsContainer.style.display = 'none';
            orderForm.style.display = 'block';
            orderItemsDiv.innerHTML = bestelling.map(p => `<p><strong>${p.item}</strong> x ${p.quantity} ${p.opmerking ? '- ' + p.opmerking : ''}</p>`).join('');
        }

        cancelOrderBtn.addEventListener('click', () => {
            orderForm.style.display = 'none';
            productsContainer.style.display = 'none';
            document.getElementById('orderTypeSelection').style.display = 'flex';
            selectedOrderType = null;
            btnPickup.classList.remove('selected');
            btnTakeaway.classList.remove('selected');
            bestelling = [];
        });

        orderForm.addEventListener('submit', async e => {
            e.preventDefault();
            try {
                const orderId = `order_${Date.now()}`;
                const amount = Math.round(bestelling.reduce((sum, p) => sum + p.quantity * p.prijs, 0) * 100);

                loadingOverlay.style.display = 'flex';

                // 📦 Stuur bestelling + bedrag naar backend
                const res = await fetch(`${backendUrl}/create_payment_intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderId,
                        amount,
                        kiosk: selectedKiosk,
                        items: bestelling,
                        orderType: selectedOrderType
                    })
                });

                if (!res.ok) throw new Error('Fout bij aanmaken betaling.');

                alert('✅ Betaling gestart! Wacht tot betaling wordt bevestigd via de app.');

                // 🔄 Wacht op bevestiging van betaling via SSE
                const evtSource = new EventSource(`${backendUrl}/payment_confirmed`);
                evtSource.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    if (data.orderId === orderId) {
                        alert("✅ Betaling bevestigd! Bestelling wordt nu klaargemaakt.");
                        evtSource.close();
                        loadingOverlay.style.display = 'none';
                        cancelOrderBtn.click();
                    }
                };

                evtSource.onerror = function () {
                    console.error("❌ SSE-verbinding verbroken.");
                    evtSource.close();
                };

            } catch (err) {
                loadingOverlay.style.display = 'none';
                alert('⛔ Fout bij betaling.');
                console.error(err);
            }
        });
    </script>

</body>
</html>

