<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Kiosk – Bestellen</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #f4fdf7;
            --fg: #0b1a12;
            --brand: #4caf50;
            --brand-600: #43a047;
            --brand-700: #388e3c;
            --muted: #7a8f85;
            --card: #ffffff;
            --danger: #b71c1c;
            --shadow: 0 10px 30px rgba(0,0,0,.10);
            --elev: 0 18px 40px rgba(56,142,60,.25);
            --radius: 18px;
            --radius-lg: 26px;
            --gap: 22px;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: 'Rubik',sans-serif;
            color: var(--fg);
            background: var(--bg);
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        /* Header */
        .top {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
        }

        .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--brand);
            box-shadow: 0 0 0 6px rgba(76,175,80,.12)
        }

        .badge {
            background: rgba(76,175,80,.12);
            color: var(--brand-700);
            padding: 10px 14px;
            border-radius: 14px;
            font-weight: 600;
        }

        /* Screens */
        .viewport {
            position: relative;
            width: 100vw;
            height: calc(100vh - 64px);
            overflow: hidden;
        }

        .screen {
            position: absolute;
            inset: 0;
            padding: 22px;
            overflow: auto;
            background: var(--bg);
            transform: translateX(100%);
            transition: transform .35s ease;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

            .screen.active {
                transform: translateX(0)
            }

            .screen.left {
                transform: translateX(-100%)
            }

        /* UI */
        h2 {
            margin: 0;
            color: var(--brand-700)
        }

        .subtitle {
            color: var(--muted)
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: var(--gap)
        }

        .btn {
            border: none;
            padding: 18px 22px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 18px;
            cursor: pointer;
            transition: transform .08s ease, box-shadow .18s ease, background .18s ease;
        }

            .btn:active {
                transform: scale(.98)
            }

        .btn-primary {
            background: var(--brand);
            color: #fff;
            box-shadow: 0 12px 26px rgba(76,175,80,.35)
        }

            .btn-primary:hover {
                background: var(--brand-600)
            }

        .btn-ghost {
            background: #fff;
            border: 2px solid #e3efe7
        }

        .btn-danger {
            background: var(--danger);
            color: #fff
        }

        .bar {
            position: sticky;
            bottom: 0;
            padding-top: 10px;
            background: linear-gradient(180deg,rgba(244,253,247,0),rgba(244,253,247,1) 32%);
        }

        .bar-inner {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--elev);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 999px;
            background: #eef9f0;
            color: #2a6f2e;
            font-weight: 700
        }

        /* Scherm 1 */
        .choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--gap);
            margin-top: 8px
        }

        .choice {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            font-size: 28px;
            font-weight: 800;
            min-height: 140px;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s, background .2s;
        }

            .choice:active {
                transform: scale(.98)
            }

            .choice.selected {
                background: #e8f5e9;
                box-shadow: var(--elev)
            }

        /* Scherm 2 */
        .product {
            background: #fff;
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .p-img {
            width: 100%;
            height: 180px;
            border-radius: 14px;
            object-fit: cover;
            background: #e4eee6
        }

        .p-name {
            font-weight: 800;
            font-size: 20px
        }

        .p-price {
            font-weight: 800;
            color: var(--brand-700)
        }

        .qty {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #eef9f0;
            border-radius: 12px;
            padding: 10px 12px;
        }

        .btn-icon {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            border: none;
            background: var(--brand);
            color: #fff;
            font-size: 22px;
            font-weight: 900;
            cursor: pointer;
        }

            .btn-icon:active {
                transform: scale(.95)
            }

        .note {
            display: none;
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1.5px solid #e1eee4;
            font-size: 15px
        }

        /* Scherm 3 */
        .card {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--elev);
            padding: 18px
        }

        .line {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px dashed #e6efe9
        }

        .muted {
            color: var(--muted);
            font-size: 14px
        }

        /* Scherm 4 */
        .center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 18px
        }

        .spinner {
            width: 92px;
            height: 92px;
            border-radius: 999px;
            border: 10px solid #eaf5ec;
            border-top-color: var(--brand);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* Scherm 5 */
        .huge {
            font-size: 36px;
            font-weight: 900;
            color: var(--brand-700);
            text-align: center
        }

        .orderid {
            font-size: 20px;
            color: #2b3d34;
            text-align: center
        }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 22px;
            background: #0b1a12;
            color: #fff;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 700;
            display: none;
            z-index: 40;
            box-shadow: 0 16px 30px rgba(0,0,0,.25);
        }

        @media(max-width:1024px) {
            .grid {
                grid-template-columns: repeat(2,1fr)
            }

            .choices {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>
<body>
    <div class="top">
        <div class="brand"><span class="dot"></span><div>OA Logica – Bestellen</div></div>
        <div id="kioskBadge" class="badge">Kiosk #–</div>
    </div>

    <div class="viewport">
        <!-- 1 -->
        <section class="screen active" id="s1">
            <h2>Kies je bestelmethode</h2>
            <div class="subtitle">Maak een keuze om verder te gaan</div>
            <div class="choices">
                <div id="btnPickup" class="choice">Ter plaatse eten</div>
                <div id="btnTakeaway" class="choice">Afhalen</div>
            </div>
        </section>

        <!-- 2 -->
        <section class="screen" id="s2">
            <h2>Kies je producten</h2>
            <div id="products" class="grid"></div>
            <div class="bar">
                <div class="bar-inner">
                    <div class="pill"><span id="cartCount">0</span> items • <span id="cartTotal">€0,00</span></div>
                    <button id="toOverview" class="btn btn-primary">Verder naar overzicht</button>
                </div>
            </div>
        </section>

        <!-- 3 -->
        <section class="screen" id="s3">
            <h2>Overzicht</h2>
            <div class="card" id="summary"></div>
            <div class="bar">
                <div class="bar-inner">
                    <button id="backToProducts" class="btn btn-ghost">Terug</button>
                    <div class="pill"><span id="sumCount">0</span> items • <span id="sumTotal">€0,00</span></div>
                    <button id="pay" class="btn btn-primary">Betalen</button>
                </div>
            </div>
            <button id="cancel" class="btn btn-danger" style="width:100%">Annuleer bestelling</button>
        </section>

        <!-- 4 -->
        <section class="screen" id="s4">
            <div class="center">
                <div class="spinner"></div>
                <div style="font-size:18px">Wachten op betaling...</div>
            </div>
        </section>

        <!-- 5 -->
        <section class="screen" id="s5">
            <div class="center" style="gap:10px">
                <div class="huge">Bedankt voor uw bestelling!</div>
                <div id="thanksOrderId" class="orderid">Order: —</div>
                <button id="nextCustomer" class="btn btn-primary" style="min-width:280px;">Volgende klant</button>
                <div class="subtitle" style="margin-top:6px">We gaan direct voor u aan de slag.</div>
            </div>
        </section>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const backendUrl = 'https://bestel-backend.onrender.com';
        const kiosk = parseInt(new URLSearchParams(location.search).get('kiosk'), 10) || 0;
        document.getElementById('kioskBadge').textContent = `Kiosk #${kiosk || '–'}`;
        if (!kiosk) alert('⛔ Kiosknummer ontbreekt (?kiosk=1)');

        const € = v => (v / 100).toLocaleString('nl-NL', { style: 'currency', currency: 'EUR' });
        const toast = (msg, ms = 1800) => { const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', ms); };

        const screens = ['s1', 's2', 's3', 's4', 's5'].map(id => document.getElementById(id));
        let idx = 0;
        function go(to) { screens.forEach((el, i) => { el.classList.remove('left', 'active'); if (i < to) el.classList.add('left'); if (i === to) el.classList.add('active'); }); idx = to; }

        let orderType = null, producten = [], cart = [], currentOrderId = null, sse = null, thanksTimer = null;
        const btnPickup = document.getElementById('btnPickup'), btnTakeaway = document.getElementById('btnTakeaway');
        btnPickup.onclick = () => { orderType = 'pickup'; btnPickup.classList.add('selected'); btnTakeaway.classList.remove('selected'); loadProducts(); };
        btnTakeaway.onclick = () => { orderType = 'takeaway'; btnTakeaway.classList.add('selected'); btnPickup.classList.remove('selected'); loadProducts(); };

        const productsEl = document.getElementById('products'), cartCount = document.getElementById('cartCount'), cartTotal = document.getElementById('cartTotal');
        const btnOverview = document.getElementById('toOverview');

        async function loadProducts() {
            try {
                const res = await fetch(`${backendUrl}/products`);
                producten = await res.json();
                renderProducts();
                go(1);
            } catch (e) { toast('⛔ Kan producten niet laden'); }
        }

        function renderProducts() {
            productsEl.innerHTML = '';
            producten.forEach((p, i) => {
                const priceCents = Math.round((p.prijs || 0) * 100);
                const card = document.createElement('div');
                card.className = 'product';
                card.innerHTML = `
              <img class="p-img" src="${p.image || 'https://via.placeholder.com/600x400?text=Product'}">
              <div class="p-name">${p.naam}</div>
              <div class="p-price">${€(priceCents)
            }</div >
              <div class="qty">
                <div style="display:flex;align-items:center;gap:10px;">
                  <button class="btn-icon dec">-</button>
                  <div class="q" style="min-width:36px;text-align:center;font-weight:900">0</div>
                  <button class="btn-icon inc">+</button>
                </div>
                <button class="btn-icon add" title="Toevoegen">+</button>
              </div>
              <textarea class="note" placeholder="Opmerking (optioneel)"></textarea>`;
            const qEl=card.querySelector('.q'),note=card.querySelector('.note');
            card.querySelector('.inc').onclick=()=>{qEl.textContent=(+qEl.textContent)+1;note.style.display=(+qEl.textContent>0)?'block':'none';};
            card.querySelector('.dec').onclick=()=>{const q=Math.max(0,(+qEl.textContent)-1);qEl.textContent=q;note.style.display=(q>0)?'block':'none';if(q===0)note.value='';};
            card.querySelector('.add').onclick=()=>{const qty=(+qEl.textContent)||1;upsertCart({id:i,naam:p.naam,prijs_cents:priceCents,qty,note:(qty>0?note.value.trim():'')});qEl.textContent=0;note.value='';note.style.display='none';toast('Toegevoegd aan bestelling');};
            productsEl.appendChild(card);
          });
          syncCartUI();
        }

        function upsertCart(item){if(item.qty<=0)return;const k=cart.findIndex(x=>x.id===item.id&&(x.note||'')===(item.note||''));if(k>-1)cart[k].qty+=item.qty;else cart.push(item);syncCartUI();}
        function syncCartUI(){const count=cart.reduce((s,x)=>s+x.qty,0);const total=cart.reduce((s,x)=>s+(x.prijs_cents*x.qty),0);cartCount.textContent=count;cartTotal.textContent=€(total);document.getElementById('sumCount').textContent=count;document.getElementById('sumTotal').textContent=€(total);}
        btnOverview.onclick=()=>{if(!cart.length){toast('Voeg eerst items toe');return;}renderSummary();go(2);};

        const summaryEl=document.getElementById('summary'),backToProducts=document.getElementById('backToProducts'),payBtn=document.getElementById('pay'),cancelBtn=document.getElementById('cancel');
        function renderSummary(){summaryEl.innerHTML='';cart.forEach(x=>{const row=document.createElement('div');row.className='line';row.innerHTML=`< div > <div style="font-weight:800">${x.naam} <span class="muted">×${x.qty}</span></div>${ x.note ? `<div class="muted">Opmerking: ${x.note}</div>` : '' }</div > <div style="font-weight:900">${€(x.prijs_cents*x.qty)}</div>`;summaryEl.appendChild(row);});}
        backToProducts.onclick=()=>go(1);

        cancelBtn.onclick=async()=>{if(currentOrderId){try{await fetch(`${ backendUrl } / api / frontend / cancel - payment`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orderId:currentOrderId})});}catch{}}resetFlow();};

        payBtn.onclick=async()=>{if(!cart.length)return;const amount=cart.reduce((s,x)=>s+(x.prijs_cents*x.qty),0);const orderId=`ORD - ${ Date.now() }`;currentOrderId=orderId;
          try{
            go(3);
            const res=await fetch(`${ backendUrl } / api / frontend / start - payment`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orderId,amount,kiosk,orderType})});
            if(!res.ok)throw new Error('start-payment failed');
            if(sse)sse.close();
            sse=new EventSource(`${ backendUrl } / payment_intent_created`);
            sse.onmessage=(ev)=>{const data=JSON.parse(ev.data||'{}');if(data.orderId!==orderId)return;if(data.status==='paid'){sse.close();showThanks(orderId);}else if(data.status==='failed'){sse.close();toast('❌ Betaling mislukt');go(2);}else if(data.status==='cancelled'){sse.close();toast('❌ Betaling geannuleerd');go(2);}};
          }catch(e){toast('⛔ Fout bij starten betaling');go(2);}
        };

        const thanksIdEl=document.getElementById('thanksOrderId'),nextBtn=document.getElementById('nextCustomer');
        nextBtn.onclick=()=>resetFlow();
        function showThanks(orderId){thanksIdEl.textContent=`Order: ${ orderId }`;go(4);if(thanksTimer)clearTimeout(thanksTimer);thanksTimer=setTimeout(()=>resetFlow(),10000);}
        function resetFlow(){if(sse){try{sse.close()}catch{}sse=null;}if(thanksTimer){clearTimeout(thanksTimer);thanksTimer=null;}orderType=null;producten=[];cart=[];currentOrderId=null;productsEl.innerHTML='';summaryEl.innerHTML='';btnPickup.classList.remove('selected');btnTakeaway.classList.remove('selected');syncCartUI();go(0);}
        window.addEventListener('beforeunload',()=>{if(sse)sse.close();});
    </script>
</body>
</html>
