<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bestellen & Betalen</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/regenerator-runtime@0.13.11/runtime.min.js"></script>
    <script type="module">
        import { StripeTerminal } from 'https://js.stripe.com/terminal/v1/terminal.mjs';

        const backendUrl = 'https://bestel-backend.onrender.com';
        const terminal = StripeTerminal.create({
            onUnexpectedReaderDisconnect: () => {
                alert('Reader onverwacht losgekoppeld!');
            }
        });

        // Kiosk nummer uit URL
        const urlParams = new URLSearchParams(window.location.search);
        const selectedKiosk = parseInt(urlParams.get('kiosk'));
        if (!selectedKiosk) {
            alert("⛔ Kiosknummer ontbreekt in de URL. Voeg '?kiosk=1' toe.");
            document.body.innerHTML = '<h1 style="color:red; text-align:center;">Kiosk niet gespecificeerd. Voeg ?kiosk=1 toe aan de URL.</h1>';
            throw new Error("Geen kiosknummer in URL.");
        }

        let selectedOrderType = null;
        let producten = [];
        let bestelling = [];

        // DOM-elementen
        const kioskDisplay = document.createElement('div');
        kioskDisplay.textContent = `Bestellen vanaf kiosk ${selectedKiosk}`;
        kioskDisplay.style.fontWeight = 'bold';
        kioskDisplay.style.marginBottom = '20px';
        document.body.prepend(kioskDisplay);

        const orderTypeDiv = document.createElement('div');
        orderTypeDiv.className = 'order-type';
        const btnPickup = document.createElement('button');
        btnPickup.textContent = 'Ter plaatse eten';
        btnPickup.dataset.type = 'pickup';
        const btnTakeaway = document.createElement('button');
        btnTakeaway.textContent = 'Afhalen';
        btnTakeaway.dataset.type = 'takeaway';
        orderTypeDiv.appendChild(btnPickup);
        orderTypeDiv.appendChild(btnTakeaway);
        document.body.appendChild(orderTypeDiv);

        const productsContainer = document.createElement('div');
        productsContainer.className = 'products';
        productsContainer.style.display = 'none';
        document.body.appendChild(productsContainer);

        const orderForm = document.createElement('form');
        orderForm.id = 'orderForm';
        orderForm.style.display = 'none';
        document.body.appendChild(orderForm);

        const orderItemsDiv = document.createElement('div');
        orderForm.appendChild(orderItemsDiv);

        const submitOrderBtn = document.createElement('button');
        submitOrderBtn.type = 'submit';
        submitOrderBtn.textContent = 'Bestelling plaatsen';
        orderForm.appendChild(submitOrderBtn);

        const cancelOrderBtn = document.createElement('button');
        cancelOrderBtn.type = 'button';
        cancelOrderBtn.textContent = 'Annuleer bestelling';
        cancelOrderBtn.className = 'cancel';
        orderForm.appendChild(cancelOrderBtn);

        // Stripe Terminal buttons
        const connectReaderBtn = document.createElement('button');
        connectReaderBtn.textContent = 'Connect Wisepad 3';
        document.body.appendChild(connectReaderBtn);

        const payBtn = document.createElement('button');
        payBtn.textContent = 'Pay €5.00';
        document.body.appendChild(payBtn);

        // ------------------ Events ------------------
        btnPickup.addEventListener('click', () => selectOrderType('pickup'));
        btnTakeaway.addEventListener('click', () => selectOrderType('takeaway'));

        function selectOrderType(type) {
            selectedOrderType = type;
            btnPickup.classList.toggle('selected', type === 'pickup');
            btnTakeaway.classList.toggle('selected', type === 'takeaway');
            loadProducts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${backendUrl}/products`);
                if (!res.ok) throw new Error('Kan producten niet ophalen.');
                producten = await res.json();
                showProducts();
            } catch (err) {
                alert('⛔ Kan producten niet ophalen.');
                console.error(err);
            }
        }

        function showProducts() {
            orderTypeDiv.style.display = 'none';
            orderForm.style.display = 'none';
            productsContainer.style.display = 'flex';
            productsContainer.innerHTML = '';

            producten.forEach((product, i) => {
                const productEl = document.createElement('div');
                productEl.className = 'product';
                productEl.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <img src="${product.image || 'https://via.placeholder.com/100'}" alt="${product.naam}">
                        <div class="product-info">
                            <h3>${product.naam}</h3>
                            <p>€${product.prijs.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="product-controls">
                        <button class="btn-decrease" data-index="${i}">-</button>
                        <span id="qty-${i}">0</span>
                        <button class="btn-increase" data-index="${i}">+</button>
                        <textarea class="opmerking" id="note-${i}" placeholder="Opmerking (optioneel)" style="display:none;"></textarea>
                    </div>
                `;
                productsContainer.appendChild(productEl);

                const btnInc = productEl.querySelector('.btn-increase');
                const btnDec = productEl.querySelector('.btn-decrease');
                const note = productEl.querySelector('textarea');

                btnInc.addEventListener('click', () => {
                    let qty = parseInt(document.getElementById(`qty-${i}`).textContent);
                    qty++;
                    document.getElementById(`qty-${i}`).textContent = qty;
                    note.style.display = qty > 0 ? 'block' : 'none';
                });
                btnDec.addEventListener('click', () => {
                    let qty = parseInt(document.getElementById(`qty-${i}`).textContent);
                    if (qty > 0) qty--;
                    document.getElementById(`qty-${i}`).textContent = qty;
                    note.style.display = qty > 0 ? 'block' : 'none';
                    if (qty === 0) note.value = '';
                });
            });

            const btnNext = document.createElement('button');
            btnNext.textContent = 'Verder naar bestelling';
            productsContainer.appendChild(btnNext);
            btnNext.addEventListener('click', (e) => {
                e.preventDefault();
                prepareOrderForm();
            });
        }

        function prepareOrderForm() {
            bestelling = [];
            producten.forEach((product, i) => {
                const qty = parseInt(document.getElementById(`qty-${i}`).textContent);
                const note = document.getElementById(`note-${i}`).value.trim();
                if (qty > 0) bestelling.push({ item: product.naam, quantity: qty, opmerking: note || '' });
            });

            if (bestelling.length === 0) {
                alert('Selecteer minimaal één product.');
                return;
            }

            productsContainer.style.display = 'none';
            orderForm.style.display = 'block';

            orderItemsDiv.innerHTML = bestelling.map(p => `<p><strong>${p.item}</strong> x ${p.quantity} ${p.opmerking ? `- ${p.opmerking}` : ''}</p>`).join('');
        }

        cancelOrderBtn.addEventListener('click', () => {
            orderForm.style.display = 'none';
            productsContainer.style.display = 'none';
            orderTypeDiv.style.display = 'block';
            selectedOrderType = null;
            btnPickup.classList.remove('selected');
            btnTakeaway.classList.remove('selected');
            bestelling = [];
        });

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch(`${backendUrl}/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ producten: bestelling, type: selectedOrderType, kiosk: selectedKiosk })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Onbekende fout');
                alert('✅ Bestelling geplaatst!');
                cancelOrderBtn.click();
            } catch (err) {
                alert('⛔ Fout bij plaatsen bestelling: ' + err.message);
                console.error(err);
            }
        });

        // ------------------ Stripe Terminal ------------------
        connectReaderBtn.addEventListener('click', async () => {
            try {
                const res = await fetch(`${backendUrl}/connection_token`, { method: 'POST' });
                const data = await res.json();
                const token = data.secret;

                const discoveredReaders = await terminal.discoverReaders({ method: 'bluetooth' });
                if (discoveredReaders.length === 0) {
                    alert('Geen readers gevonden.');
                    return;
                }

                const reader = await terminal.connectReader(discoveredReaders[0], token);
                alert(`Verbonden met reader: ${reader.label || reader.serial_number}`);
            } catch (err) {
                console.error(err);
                alert('Fout bij verbinden met reader: ' + err.message);
            }
        });

        payBtn.addEventListener('click', async () => {
            try {
                const piRes = await fetch(`${backendUrl}/create-payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: 500 }) // €5.00
                });
                const piData = await piRes.json();

                await terminal.collectPaymentMethod(piData.clientSecret);
                await terminal.processPayment(piData.clientSecret);

                alert('✅ Betaling voltooid!');
            } catch (err) {
                console.error(err);
                alert('⛔ Fout bij betaling: ' + err.message);
            }
        });
    </script>
</head>
<body>
</body>
</html>